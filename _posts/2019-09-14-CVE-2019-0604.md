---
title: SharePoint CVE-2019-0604 RCE Detection
date: 2019-09-14
tags: [CVE, Detetction, Web, Exploit]
categories: [Exploit, Detetction]
render_with_liquid: true
---

## Introduction

I decided to write this post as I did not notice any significant detection methods published publicly. In this post, a quick PoC will be demonstrated and analysis of the generated logs by the exploit will be discussed to provide detection methods for the initial stages of the attack.

If you want to read more about the exploit and how it works, I advise to read the below articles:

* [https://www.zerodayinitiative.com/blog/2019/3/13/cve-2019-0604-details-of-a-microsoft-sharepoint-rce-vulnerability](https://www.zerodayinitiative.com/blog/2019/3/13/cve-2019-0604-details-of-a-microsoft-sharepoint-rce-vulnerabilityhttps:/)
* [https://www.zerodayinitiative.com/blog/2019/3/13/cve-2019-0604-details-of-a-microsoft-sharepoint-rce-vulnerability](https://www.zerodayinitiative.com/blog/2019/3/13/cve-2019-0604-details-of-a-microsoft-sharepoint-rce-vulnerability)

## PoC Demonstration


{% include embed/video.html src='assets/vid/20190914/poc.mp4' types=mp4 title='Text' %}
> In the above video you will see the exploit and executing remote command creating new process towards target server by sending a crafted HTTP POST request with particular URL path and payload parameter and value.
{: .prompt-info }

## Network Analysis And Detection 

As shown in the PoC video, the exploit is done through sending a crafted HTTP POST request to SharePoint web app. The following picture details the request structure.
![Desktop View](assets/img/20190914/1.jpg)
_Exploit packet capture_

The crafted HTTP POST packet capture has the following characteristics which also will be used for a detection:
* URI:  /_layouts/15/Picker.aspx
* URI query (two URIs):
** PickerDialogType=Microsoft.SharePoint.WebControls.ItemPickerDialog
** PickerDialogType=Microsoft.SharePoint.Portal.WebControls.ItemPickerDialog
* POST payload parameter: ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData

The POST parameter value should contain an encoded/serialized .Net XML payload that will be loaded and might executed in target SharePoint server side depending in the value context. A malicious payload should start with double underscores "__" to get the exploit work and to force the payload reaching to XML deserialization function in SharePoint internal code, which ultimately causes remote command execution. Following figure shows SharePoint internal code to match double underscores "__" and reaching XML deserialization function.

![Desktop View](assets/img/20190914/2.jpg)
_SharePoint vulnerable code_

We can detect an exploit attempt with such IDS snort rule:
'''yaml
alert tcp $EXTERNAL_NET any -> $SHAREPOINT_SERVERS [80,443] (msg:"SharePoint CVE-2019-0604 RCE Exploit Attempt"; flow:established,to_server; content:"POST"; http_method; content:"Picker.aspx?PickerDialogType=Microsoft.SharePoint"; http_uri; nocase; content:"ctl00|25|24PlaceHolderDialogBodySection|25|24ctl05|25|24hiddenSpanData|3d5f5f|";http_client_body; nocase; fast_pattern; reference:adraft.page/index.php/2019/09/14/cve-2019-0604-sharepoint-rce-forensics-analysis-and-detection-methods; sid:3000001; rev:1;)
'''



